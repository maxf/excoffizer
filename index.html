<!DOCTYPE HTML>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Main</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/7.0.0/normalize.min.css" rel="stylesheet">
    <link href="material-components-web.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500" rel="stylesheet">
    <link href="main.css" rel="stylesheet">
  </head>
  <body class="mdc-typography">
    <script src="elm-mdc.js"></script>
    <script src="elm.js"></script>

    <script src="excoffizer.js"></script>
    <script src="utils.js"></script>

    <canvas id="output_canvas" width="400" height="400"></canvas>
    <div>
      <canvas class="preview" id="preview_canvas_0" width="80" height="80"></canvas>
      <canvas class="preview" id="preview_canvas_1" width="80" height="80"></canvas>
      <canvas class="preview" id="preview_canvas_2" width="80" height="80"></canvas>
      <canvas class="preview" id="preview_canvas_3" width="80" height="80"></canvas>
    </div>

    <input id="file_selector" type="file" accept="image/*;capture=camera"/>
    <img id="source_image" src="dali.png" height="400"/>
    <canvas id="input_canvas" width="400" height="400"></canvas>
    <div id="elm"></div>
    <script>
     const sourceImage = document.getElementById('source_image');
     const fileSelector = document.getElementById('file_selector');
     const inputCanvas = document.getElementById('input_canvas');
     const outputCanvas = document.getElementById('output_canvas');
     let previewCanvas = [];
     for (let i=0; i<4; i++) {
       previewCanvas[i] = document.getElementById('preview_canvas_'+i);
     }
     const inputCanvasCtx = inputCanvas.getContext('2d');
     const params = [
       {
         theta: 40,
         waviness: 10,
         line_height: 100,
         sx: 1,
         sy: 1,
         tx: 0,
         ty: 0,
         opacity: 0,
         contrast: 0,
         outputCanvas: previewCanvas[0],
         inputCanvas: inputCanvas
       }, {
         theta: 20,
         waviness: 10,
         line_height: 100,
         sx: 1,
         sy: 1,
         tx: 0,
         ty: 0,
         opacity: 0,
         contrast: 0,
         outputCanvas: previewCanvas[1],
         inputCanvas: inputCanvas
       }, {
         theta: 80,
         waviness: 10,
         line_height: 100,
         sx: 1,
         sy: 1,
         tx: 0,
         ty: 0,
         opacity: 10,
         contrast: 0,
         outputCanvas: previewCanvas[2],
         inputCanvas: inputCanvas
       }, {
         theta: 45,
         waviness: 10,
         line_height: 100,
         sx: 1,
         sy: 1,
         tx: 0,
         ty: 0,
         opacity: 0,
         contrast: 10,
         outputCanvas: previewCanvas[3],
         inputCanvas: inputCanvas
       }
     ];

     const app = Elm.Main.init({
       node: document.getElementById('elm')
     });

     app.ports.render.subscribe(params => {
       params.inputCanvas = inputCanvas;
       params.outputCanvas = outputCanvas;
       const success = Excoffizer.render(params);
       app.ports.renderDone.send(success);
     });

     fileSelector.onchange = function(e) {
       var fr = new FileReader();
       fr.onload = function() {
         sourceImage.setAttribute('src', fr.result);
         renderNewImage();
       }
       fr.readAsDataURL(e.target.files[0]);
     };

     const renderNewImage = function() {
       let t = new Image();
       t.onload = function() {
         inputCanvas.width = t.width;
         inputCanvas.height = t.height;
         inputCanvasCtx.drawImage(t,0,0);

         /* for (i=0; i<4; i++) {
          *   previewCanvas[i].width = 80*t.width/t.height;
          *   previewCanvas[i].height = 80;
          *   Excoffizer.render(params[i]);
          * } */

         previewCanvas[0].width = 80*t.width/t.height;
         previewCanvas[0].height = 80;
         Excoffizer.render(params[0]);

         outputCanvas.width = 400*t.width/t.height;
         outputCanvas.height = 400;
         app.ports.newImageLoaded.send(true);
       };
       t.src = sourceImage.getAttribute('src');
     };

     renderNewImage();

    </script>

  </body>
</html>
